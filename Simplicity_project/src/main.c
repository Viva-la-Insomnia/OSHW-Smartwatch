/**************************************************************************//**
 * @file
 * @brief Empty Project
 * @author Energy Micro AS
 * @version 3.20.2
 ******************************************************************************
 * @section License
 * <b>(C) Copyright 2014 Silicon Labs, http://www.silabs.com</b>
 *******************************************************************************
 *
 * This file is licensed under the Silicon Labs Software License Agreement. See 
 * "http://developer.silabs.com/legal/version/v11/Silicon_Labs_Software_License_Agreement.txt"  
 * for details. Before using this software for any purpose, you must agree to the 
 * terms of that agreement.
 *
 ******************************************************************************/
/**************************************************************************//**
 * @file main.c
 * @brief OSHW-Smartwatch main code
 * @author Tuomas Tinus, Jimi JÃ¤rvelin
 * @version 0.5
 ******************************************************************************/

#include "em_device.h"
#include "em_chip.h"
#include "udelay.h"
#include "mdelay.h"
#include "BQ25010.h"
#include "BQ27421.h"
#include "MPU9250.h"
#include "LS013_MD.h"
#include "InitDevice.h"

const uint16_t LoadingBackground[] = { 0xc000, 0xff, 0xffe0, 0x3, 0xffff, 0xf000, 0xc000, 0xff, 0xffe0, 0x3,
		 0xffff, 0xe000, 0xe000, 0xff, 0xffe0, 0x3, 0xffff, 0xe000, 0xe000, 0x7f,
		 0xffe0, 0x7, 0xffff, 0xc000, 0xf000, 0x7f, 0xffe0, 0x7, 0xffff, 0xc000,
		 0xf000, 0x7f, 0xffe0, 0x7, 0xffff, 0x8000, 0xf800, 0x3f, 0xffe0, 0xf,
		 0xffff, 0x0, 0xfc00, 0x3f, 0xffe0, 0xf, 0xffff, 0x0, 0xfc00, 0x3f,
		 0xffe0, 0xf, 0xfffe, 0x0, 0xfe00, 0x3f, 0xffe0, 0xf, 0xfffe, 0x0,
		 0xfe00, 0x1f, 0xffe0, 0x1f, 0xfffc, 0x0, 0xff00, 0x1f, 0xffe0, 0x1f,
		 0xfffc, 0x0, 0xff00, 0x1f, 0xffe0, 0x1f, 0xfff8, 0x0, 0xff80, 0x1f,
		 0xffe0, 0x1f, 0xfff0, 0x0, 0xffc0, 0xf, 0xffe0, 0x3f, 0xfff0, 0x0,
		 0xffc0, 0xf, 0xffe0, 0x3f, 0xffe0, 0x0, 0xffe0, 0xf, 0xffe0, 0x3f,
		 0xffe0, 0x0, 0xffe0, 0xf, 0xffe0, 0x3f, 0xffc0, 0x0, 0xfff0, 0x7,
		 0xffe0, 0x7f, 0xff80, 0x0, 0xfff0, 0x7, 0xffe0, 0x7f, 0xff80, 0x0,
		 0xfff8, 0x7, 0xffe0, 0x7f, 0xff00, 0x1, 0xfffc, 0x3, 0xffe0, 0x7f,
		 0xff00, 0x7, 0xfffc, 0x3, 0xffe0, 0xff, 0xfe00, 0x7, 0xfffe, 0x3,
		 0xffe0, 0xff, 0xfe00, 0x1f, 0xfffe, 0x3, 0xffe0, 0xff, 0xfc00, 0x1f,
		 0xffff, 0x1, 0xffe0, 0x1ff, 0xf800, 0x3f, 0xffff, 0x8001, 0xffe0, 0x1ff,
		 0xf800, 0xff, 0xffff, 0x8001, 0xffe0, 0x1ff, 0xf000, 0x1ff, 0xffff, 0xc001,
		 0xffe0, 0x1ff, 0xf000, 0x3ff, 0x7fff, 0xc000, 0xffe0, 0x3ff, 0xe000, 0x7ff,
		 0x3fff, 0xe000, 0xffe0, 0x3ff, 0xe000, 0x7ff, 0x1fff, 0xe000, 0xffe0, 0x1f,
		 0xc000, 0x1fff, 0xfff, 0xf000, 0x7f00, 0x0, 0x8000, 0x3fff, 0x7ff, 0xf800,
		 0x7c00, 0x0, 0x0, 0x3fff, 0x3ff, 0xf800, 0x7800, 0x0, 0x0, 0xffff,
		 0x1ff, 0xfc00, 0x7000, 0x0, 0x0, 0xffff, 0xff, 0xfc00, 0x6000, 0x0,
		 0x1, 0xffff, 0x7f, 0xfe00, 0x0, 0x0, 0x3, 0xffff, 0x3f, 0xfe00,
		 0x0, 0x0, 0xf, 0xffff, 0x1f, 0xff00, 0x0, 0x0, 0x1f, 0xffff,
		 0xf, 0xff80, 0x0, 0x0, 0x1f, 0xffff, 0x7, 0xff80, 0x0, 0x0,
		 0x7f, 0xfffe, 0x3, 0xffc0, 0x0, 0x0, 0x7f, 0xfff8, 0x1, 0xffc0,
		 0x1f0, 0x0, 0x7f, 0xfff0, 0x0, 0xffe0, 0x1f0, 0x0, 0x7f, 0xffc0,
		 0x0, 0x7fe0, 0x3f0, 0x0, 0x3f, 0xff00, 0x0, 0x3ff0, 0x3f0, 0x0,
		 0x3f, 0xfc00, 0x0, 0x1ff8, 0xff0, 0x0, 0x3f, 0xf800, 0xc000, 0xff8,
		 0xfff, 0xfffc, 0x3f, 0xe000, 0xf000, 0x7fc, 0xfff, 0xffff, 0xff3f, 0x8000,
		 0xfc00, 0x3fc, 0xff, 0xffff, 0xfffe, 0x0, 0xfe00, 0x1fc, 0x0, 0x0,
		 0xfffc, 0x0, 0xff80, 0xfc, 0x3, 0xffe0, 0x70, 0x0, 0xffe0, 0x78,
		 0xc003, 0xfffc, 0x340, 0x0, 0xfff0, 0x39, 0xe003, 0xfff8, 0x380, 0x0,
		 0xfffc, 0x19, 0xe003, 0xffe0, 0x380, 0x0, 0xffff, 0x8, 0xe001, 0xff80,
		 0x380, 0x0, 0xffff, 0xc000, 0x4030, 0xfe00, 0x300, 0x0, 0xffff, 0xe000,
		 0x30, 0x3800, 0x0, 0x3, 0xffff, 0xf800, 0x38, 0x0, 0x0, 0x3f,
		 0x7fff, 0xfe00, 0x7c, 0x0, 0x0, 0x3ff, 0x7ff, 0xff80, 0x7c, 0x0,
		 0x0, 0x3fff, 0xff, 0xff80, 0x7f, 0x0, 0x3, 0xffff, 0xf, 0xff80,
		 0x3f, 0x0, 0x1f, 0xffff, 0x0, 0xff00, 0x3e, 0x0, 0xff, 0xffff,
		 0x0, 0x1f00, 0x18, 0x0, 0x3c7f, 0xffff, 0x0, 0x0, 0x0, 0x0,
		 0xfc7f, 0xffff, 0x0, 0x0, 0x0, 0x3, 0xfe7f, 0xffff, 0x0, 0x0,
		 0x1000, 0x7, 0xfcff, 0xffff, 0x0, 0x0, 0x0, 0x1f, 0xc0ff, 0xffff,
		 0x0, 0x0, 0x0, 0x7f, 0xff, 0xffff, 0x0, 0x0, 0x0, 0x1f0,
		 0x7f, 0xffff, 0xffff, 0xff00, 0x0, 0x180, 0x0, 0x0, 0xffff, 0xff80,
		 0x0, 0x0, 0x0, 0x0, 0xffff, 0xffe0, 0x0, 0x0, 0x0, 0x0,
		 0xffff, 0xfffc, 0x0, 0x0, 0x0, 0x0, 0xffff, 0xff8f, 0x0, 0x0,
		 0x0, 0x0, 0xffff, 0xf80f, 0x0, 0x0, 0x0, 0x0, 0xffff, 0xc00f,
		 0x8000, 0x0, 0x0, 0x0, 0xfffc, 0xf, 0xe000, 0x0, 0x1800, 0x0,
		 0xffc0, 0x7, 0xf800, 0x0, 0x1800, 0x0, 0xfc00, 0x0, 0xfe00, 0x0,
		 0x180e, 0x0, 0xc000, 0x0, 0x3f00, 0x0, 0x380f, 0xc000, 0x0, 0x0,
		 0xf80, 0x180, 0x780f, 0xfc00, 0x0, 0x200, 0x780, 0x3e0, 0xf9c7, 0xffc0,
		 0x0, 0x300, 0x1c0, 0x7e1, 0xffc1, 0xfff8, 0x0, 0x180, 0xe0, 0x7e3,
		 0xffc0, 0x7fff, 0x0, 0x180, 0x20, 0x7c7, 0xf3c0, 0x1fff, 0x0, 0xc0,
		 0x0, 0x187, 0xe000, 0xfff, 0x0, 0xe0, 0x0, 0x7, 0xc000, 0x3ff,
		 0x0, 0x60, 0x0, 0x0, 0x0, 0x1ff, 0x0, 0x60, 0x0, 0x0,
		 0x100, 0xff, 0x0, 0x30, 0x0, 0x0, 0x100, 0x7f, 0x0, 0x30,
		 0x0, 0x0, 0x80, 0x7f, 0x0, 0x30, 0x0, 0x0, 0x80, 0x3f,
		 0x0, 0x30, 0x0, 0x0, 0x40, 0x1f, };


int main(void)
{
  /* Initialise the chip - included for backwards compatibility.
   * Do not add code before this point							*/
  CHIP_Init();

  /* Start in default mode */
  enter_DefaultMode_from_RESET();

  //Calibrate the delay
  UDELAY_Calibrate();

  /* Initialise the subsystems
   * after 150ms delay for them to boot */
  MDELAY_Delay(150);
  BQ25010_init();
  BQ27421_Init();
  MPU9250_Init();
  LS013_Init();
  LS013_SetBuffer(LoadingBackground);
  LS013_Refresh(1);
  LS013_Enable();

  float AK8963_sensitivityadj[3];
  MPU9250_InitAK8963(AK8963_sensitivityadj);

  float gyro_bias[3];
  float	acc_bias[3];
  MPU9250_Calibrate(gyro_bias, acc_bias);

  float selftest_results[6];
  MPU9250_SelfTest(selftest_results);

  /* Infinite loop */
  while (1) {
	  MDELAY_Delay(200);
	  LS013_InvertPolarity();
  }
}
